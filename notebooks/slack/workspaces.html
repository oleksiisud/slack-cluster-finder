<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Slack Workspaces</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .loading {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4A154B;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .workspace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .workspace-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .workspace-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        }

        .workspace-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .workspace-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4A154B 0%, #611f69 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .workspace-info h2 {
            color: #2c3e50;
            font-size: 1.3rem;
            margin-bottom: 3px;
        }

        .workspace-type {
            color: #7f8c8d;
            font-size: 0.85rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .workspace-details {
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .detail-label {
            color: #7f8c8d;
            font-weight: 500;
        }

        .detail-value {
            color: #2c3e50;
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .badge.active {
            background: #d4edda;
            color: #155724;
        }

        .badge.private {
            background: #fff3cd;
            color: #856404;
        }

        .error {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .error-icon {
            font-size: 4rem;
            color: #e74c3c;
            margin-bottom: 20px;
        }

        .error h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .error p {
            color: #7f8c8d;
        }

        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #e74c3c;
        }

        .stats {
            background: white;
            border-radius: 16px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            flex: 1;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4A154B;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .channels-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .channels-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .channel-list {
            display: grid;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .channel-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .channel-item:hover {
            background: #e9ecef;
        }

        .channel-item.selected {
            background: #e7f3ff;
            border: 2px solid #4A154B;
        }

        .channel-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .channel-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .channel-info {
            flex: 1;
        }

        .channel-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .channel-meta {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .extract-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #4A154B 0%, #611f69 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .extract-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 21, 75, 0.4);
        }

        .extract-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .select-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .select-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .select-btn:hover {
            background: #e9ecef;
        }

        .users-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .users-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .user-item:hover {
            background: #e9ecef;
        }

        .user-item.selected {
            background: #e7f3ff;
            border: 2px solid #4A154B;
        }

        .user-checkbox {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 0.75rem;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ My Slack Workspaces</h1>
            <p class="subtitle">All workspaces where you have access</p>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="color: #7f8c8d; font-size: 1.1rem;">Loading your workspaces...</p>
        </div>

        <div id="stats" style="display: none;"></div>
        <div id="workspaces" class="workspace-grid" style="display: none;"></div>
        <div id="channels" class="channels-section" style="display: none;">
            <h2>üìÅ Select Channels to Extract</h2>
            <div class="select-controls">
                <button class="select-btn" onclick="selectAllChannels()">Select All</button>
                <button class="select-btn" onclick="selectNoneChannels()">Select None</button>
                <button class="select-btn" onclick="selectPublicOnly()">Public Only</button>
                <button class="select-btn" onclick="selectPrivateOnly()">Private Only</button>
            </div>
            <div id="channelList" class="channel-list"></div>
        </div>
        <div id="users" class="users-section" style="display: none;">
            <h2>üë• Select Users to Extract Messages From</h2>
            <div class="select-controls">
                <button class="select-btn" onclick="selectAllUsers()">Select All</button>
                <button class="select-btn" onclick="selectNoneUsers()">Select None</button>
            </div>
            <div id="userList" class="user-list"></div>
            <button class="extract-button" onclick="extractMessages()" id="extractBtn">
                Extract Messages from Selected Channels & Users
            </button>
        </div>
        <div id="error" style="display: none;"></div>
    </div>

    <script>
        let allChannels = [];
        let selectedChannels = new Set();
        let allUsers = [];
        let selectedUsers = new Set();

        async function loadWorkspaces() {
            try {
                // Fetch from our local proxy server
                const response = await fetch('http://localhost:8080/api/workspaces');
                const data = await response.json();

                if (!data.ok) {
                    throw new Error(data.error || 'Failed to fetch workspace data');
                }

                // Display the workspace
                displayWorkspace(data.auth, data.team, data.channels, data.users);
            } catch (error) {
                showError(error.message);
            }
        }

        function displayWorkspace(authData, team, channels, users) {
            document.getElementById('loading').style.display = 'none';

            // Debug: Log the data to see what we're getting
            console.log('Auth Data:', authData);
            console.log('Team Data:', team);
            console.log('Channels:', channels);
            console.log('Users:', users);

            const publicChannels = channels.filter(c => !c.is_private);
            const privateChannels = channels.filter(c => c.is_private);

            // Display stats
            const statsHtml = `
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number">1</div>
                        <div class="stat-label">Workspace</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${publicChannels.length}</div>
                        <div class="stat-label">Public Channels</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${privateChannels.length}</div>
                        <div class="stat-label">Private Channels</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${channels.length}</div>
                        <div class="stat-label">Total Channels</div>
                    </div>
                </div>
            `;
            document.getElementById('stats').innerHTML = statsHtml;
            document.getElementById('stats').style.display = 'block';

            // Display workspace card
            const teamName = team.name || 'Slack Workspace';
            const initial = teamName.charAt(0).toUpperCase();
            const teamIcon = team.icon?.image_132 || team.icon?.image_102 || team.icon?.image_88 || null;
            
            console.log('Team Name:', teamName);
            console.log('Team Icon Object:', team.icon);
            console.log('Selected Icon URL:', teamIcon);
            
            const workspaceHtml = `
                <div class="workspace-card">
                    <div class="workspace-header">
                        ${teamIcon 
                            ? `<img src="${teamIcon}" alt="${teamName}" class="workspace-icon" style="border-radius: 10px;" onerror="console.error('Failed to load image:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                               <div class="workspace-icon" style="display: none;">${initial}</div>` 
                            : `<div class="workspace-icon">${initial}</div>`
                        }
                        <div class="workspace-info">
                            <h2>${teamName}</h2>
                            <div class="workspace-type">Primary Workspace</div>
                        </div>
                    </div>
                    <div class="workspace-details">
                        <div class="detail-row">
                            <span class="detail-label">Team ID:</span>
                            <span class="detail-value">${team.id || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Your User ID:</span>
                            <span class="detail-value">${authData.user_id || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Domain:</span>
                            <span class="detail-value">${team.domain ? team.domain + '.slack.com' : 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Public Channels:</span>
                            <span class="detail-value">${publicChannels.length}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Private Channels:</span>
                            <span class="detail-value">${privateChannels.length}</span>
                        </div>
                    </div>
                    <span class="badge active">‚úì Connected</span>
                </div>
            `;

            document.getElementById('workspaces').innerHTML = workspaceHtml;
            document.getElementById('workspaces').style.display = 'grid';

            // Display channels
            allChannels = channels;
            displayChannels(channels);

            // Display users
            allUsers = users.filter(u => !u.deleted && !u.is_bot);
            displayUsers(allUsers);
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            
            const errorHtml = `
                <div class="error">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <h2>Failed to Load Workspaces</h2>
                    <p>${message}</p>
                    <p style="margin-top: 10px;">
                        <small>Check your <code>USER_TOKEN</code> in the .env file</small>
                    </p>
                </div>
            `;
            document.getElementById('error').innerHTML = errorHtml;
            document.getElementById('error').style.display = 'block';
        }

        function displayChannels(channels) {
            const channelList = document.getElementById('channelList');
            
            const channelsHtml = channels.map(channel => {
                const isPrivate = channel.is_private;
                const icon = isPrivate ? 'üîí' : '#';
                const type = isPrivate ? 'Private' : 'Public';
                const members = channel.num_members || 0;
                
                return `
                    <div class="channel-item" onclick="toggleChannel('${channel.id}')" id="channel-${channel.id}">
                        <input type="checkbox" class="channel-checkbox" 
                               onchange="toggleChannel('${channel.id}')" 
                               id="checkbox-${channel.id}">
                        <span class="channel-icon">${icon}</span>
                        <div class="channel-info">
                            <div class="channel-name">${channel.name}</div>
                            <div class="channel-meta">${type} ‚Ä¢ ${members} members</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            channelList.innerHTML = channelsHtml;
            document.getElementById('channels').style.display = 'block';
            
            // Select all by default
            selectAllChannels();
        }

        function toggleChannel(channelId) {
            const checkbox = document.getElementById(`checkbox-${channelId}`);
            const item = document.getElementById(`channel-${channelId}`);
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                selectedChannels.add(channelId);
                item.classList.add('selected');
            } else {
                selectedChannels.delete(channelId);
                item.classList.remove('selected');
            }
            
            updateExtractButton();
        }

        function selectAllChannels() {
            allChannels.forEach(channel => {
                selectedChannels.add(channel.id);
                const checkbox = document.getElementById(`checkbox-${channel.id}`);
                const item = document.getElementById(`channel-${channel.id}`);
                if (checkbox) {
                    checkbox.checked = true;
                    item.classList.add('selected');
                }
            });
            updateExtractButton();
        }

        function selectNoneChannels() {
            selectedChannels.clear();
            allChannels.forEach(channel => {
                const checkbox = document.getElementById(`checkbox-${channel.id}`);
                const item = document.getElementById(`channel-${channel.id}`);
                if (checkbox) {
                    checkbox.checked = false;
                    item.classList.remove('selected');
                }
            });
            updateExtractButton();
        }

        function selectPublicOnly() {
            selectNoneChannels();
            allChannels.filter(c => !c.is_private).forEach(channel => {
                selectedChannels.add(channel.id);
                const checkbox = document.getElementById(`checkbox-${channel.id}`);
                const item = document.getElementById(`channel-${channel.id}`);
                if (checkbox) {
                    checkbox.checked = true;
                    item.classList.add('selected');
                }
            });
            updateExtractButton();
        }

        function selectPrivateOnly() {
            selectNoneChannels();
            allChannels.filter(c => c.is_private).forEach(channel => {
                selectedChannels.add(channel.id);
                const checkbox = document.getElementById(`checkbox-${channel.id}`);
                const item = document.getElementById(`channel-${channel.id}`);
                if (checkbox) {
                    checkbox.checked = true;
                    item.classList.add('selected');
                }
            });
            updateExtractButton();
        }

        function updateExtractButton() {
            const btn = document.getElementById('extractBtn');
            const channelCount = selectedChannels.size;
            const userCount = selectedUsers.size;
            
            if (channelCount === 0 || userCount === 0) {
                btn.disabled = true;
                btn.textContent = channelCount === 0 ? 'Select at least one channel' : 'Select at least one user';
            } else {
                btn.disabled = false;
                btn.textContent = `Extract from ${channelCount} Channel${channelCount !== 1 ? 's' : ''} √ó ${userCount} User${userCount !== 1 ? 's' : ''}`;
            }
        }

        function extractMessages() {
            const selectedChannelObjects = allChannels.filter(c => selectedChannels.has(c.id));
            const selectedUserObjects = allUsers.filter(u => selectedUsers.has(u.id));
            
            console.log('Extracting messages from channels:', selectedChannelObjects);
            console.log('Extracting messages from users:', selectedUserObjects);
            
            alert(`Would extract messages from:\n\nüìÅ ${selectedChannels.size} channels:\n${selectedChannelObjects.map(c => '  ‚Ä¢ ' + c.name).join('\n')}\n\nüë• ${selectedUsers.size} users:\n${selectedUserObjects.map(u => '  ‚Ä¢ ' + (u.real_name || u.name)).join('\n')}\n\n(Backend integration needed)`);
        }

        function displayUsers(users) {
            const userList = document.getElementById('userList');
            
            const usersHtml = users.map(user => {
                const avatar = user.profile?.image_32 || 'https://via.placeholder.com/32';
                const name = user.real_name || user.name;
                const status = user.profile?.status_text || '';
                
                return `
                    <div class="user-item" onclick="toggleUser('${user.id}')" id="user-${user.id}">
                        <input type="checkbox" class="user-checkbox" 
                               onchange="toggleUser('${user.id}')" 
                               id="userbox-${user.id}">
                        <img src="${avatar}" alt="${name}" class="user-avatar">
                        <div class="user-info">
                            <div class="user-name">${name}</div>
                            ${status ? `<div class="user-status">${status}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            userList.innerHTML = usersHtml;
            document.getElementById('users').style.display = 'block';
            
            // Select all by default if less than 20 users
            if (users.length < 20) {
                selectAllUsers();
            } else {
                updateExtractButton();
            }
        }

        function toggleUser(userId) {
            const checkbox = document.getElementById(`userbox-${userId}`);
            const item = document.getElementById(`user-${userId}`);
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                selectedUsers.add(userId);
                item.classList.add('selected');
            } else {
                selectedUsers.delete(userId);
                item.classList.remove('selected');
            }
            
            updateExtractButton();
        }

        function selectAllUsers() {
            allUsers.forEach(user => {
                selectedUsers.add(user.id);
                const checkbox = document.getElementById(`userbox-${user.id}`);
                const item = document.getElementById(`user-${user.id}`);
                if (checkbox) {
                    checkbox.checked = true;
                    item.classList.add('selected');
                }
            });
            updateExtractButton();
        }

        function selectNoneUsers() {
            selectedUsers.clear();
            allUsers.forEach(user => {
                const checkbox = document.getElementById(`userbox-${user.id}`);
                const item = document.getElementById(`user-${user.id}`);
                if (checkbox) {
                    checkbox.checked = false;
                    item.classList.remove('selected');
                }
            });
            updateExtractButton();
        }

        // Load on page load
        loadWorkspaces();
    </script>
</body>
</html>
